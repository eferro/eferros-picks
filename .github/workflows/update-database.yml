name: Update Database
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
jobs:
  export:
    runs-on: ubuntu-latest
    env:
      AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
      GH_ACTIONS_PAT: ${{ secrets.GH_ACTIONS_PAT }}
    steps:
      - uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          persist-credentials: true
      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install Dependencies
        run: pip install airtable-export
      - name: Export Airtable Database
        run: |
          mkdir -p database
          airtable-export database appEq6pzSjq7DugAR --key=$AIRTABLE_API_KEY  --sqlite database/picks.db Resources Speakers Topics --json --ndjson --yaml  
      - name: Commit updated Database
        run: |
          git config --global user.name "Eduardo Ferro"
          git config --global user.email "eferro@eferro.net"
          git add database/picks.db
          git add database/Resources.json
          git add database/Resources.ndjson
          git add database/Resources.yml
          git add database/Speakers.json
          git add database/Speakers.ndjson
          git add database/Speakers.yml
          git add database/Topics.json
          git add database/Topics.ndjson
          git add database/Topics.yml          
          git commit -m "Exported Airtable Database"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          ssh: true
          branch: ${{ github.ref }}
